<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Revenue Physics Engine — Governed Revenue Architecture</title>
<meta name="description" content="Model revenue dynamics under constraint. Multi-segment scenario analysis with drift decay, pipeline stress, and capital allocation visualization.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;500;600;700;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
:root{--bk:#1a1918;--gy:#f0f0f0;--or:#ff6e3e;--pu:#bcbeff;--wh:#fff;--g50:#f8f8f8;--g3:#d9d9d9;--g4:#ccc;--g5:#b5b5b5;--g6:#a3a3a3;--g7:#747474;--g9:#2b2b2b;--ft:'Oxanium',sans-serif;--mn:'Space Mono',monospace;--sm:cubic-bezier(.32,.72,0,1);--ez:cubic-bezier(.215,.61,.355,1)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-font-smoothing:antialiased;scroll-behavior:smooth}
body{font-family:var(--ft);font-weight:400;background:var(--gy);color:var(--bk);overflow-x:hidden;line-height:1.4}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--g4);border-radius:2px}
a{color:inherit;text-decoration:none}

/* NAV */
.nav{position:sticky;top:0;z-index:100;padding:0 20px;height:56px;display:flex;align-items:center;background:var(--gy);border-bottom:1px solid var(--g3);transition:background .4s var(--ez)}
.nav.scrolled{background:rgba(240,240,240,.88);backdrop-filter:blur(12px)}
.n-logo{display:flex;align-items:center;gap:8px}
.n-logo svg{width:22px;height:22px}
.n-word{font-family:var(--mn);font-size:11px;font-weight:400;letter-spacing:.02em}
.nr{margin-left:auto;display:flex;align-items:center;gap:4px}
.n-lnk{font-family:var(--mn);font-size:9px;padding:5px 8px;color:var(--g7);text-decoration:none;white-space:nowrap;transition:color .3s var(--ez);text-transform:lowercase;letter-spacing:.02em}
.n-lnk:hover{color:var(--bk)}
.n-lnk.active{color:var(--or)}
.btn-out{font-family:var(--mn);font-size:10px;padding:7px 16px;border:1px solid var(--bk);background:transparent;color:var(--bk);cursor:pointer;transition:all .4s var(--ez);white-space:nowrap;text-transform:lowercase;letter-spacing:.02em;text-decoration:none;display:inline-block}
.btn-out:hover{background:var(--bk);color:var(--wh)}
.btn-fill{font-family:var(--mn);font-size:10px;padding:7px 16px;border:1px solid var(--bk);background:var(--bk);color:var(--wh);cursor:pointer;transition:all .4s var(--ez);white-space:nowrap;text-transform:lowercase;letter-spacing:.02em;text-decoration:none;display:inline-block}
.btn-fill:hover{background:var(--or);border-color:var(--or);color:var(--bk)}
.ham{display:none;background:none;border:none;cursor:pointer;padding:8px;flex-direction:column;gap:4px;margin-left:8px}
.ham span{display:block;width:18px;height:1.5px;background:var(--bk);transition:all .3s var(--ez)}
.mob-menu{display:none;position:fixed;top:56px;left:0;right:0;bottom:0;background:var(--gy);padding:24px 20px;z-index:99;flex-direction:column;gap:4px;overflow-y:auto}
.mob-menu.open{display:flex}
.mob-btns{display:flex;gap:8px;margin-bottom:24px}
.mob-btns .btn-out,.mob-btns .btn-fill{flex:1;text-align:center;padding:14px 8px;font-size:11px}
.mob-lnk{font-family:var(--mn);font-size:12px;padding:14px 0;color:var(--g7);border-bottom:1px solid var(--g3);text-transform:lowercase;letter-spacing:.02em;display:block;text-decoration:none}
.mob-lnk:hover{color:var(--bk)}
@media(max-width:960px){.n-lnk{display:none}.ham{display:flex}}

/* LAYOUT */
.w{max-width:1200px;margin:0 auto;padding:0 20px}
@media(min-width:860px){.w{padding:0 40px}}
@keyframes up{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* HERO */
.hero{padding:80px 0 40px}
.h-ey{font-family:var(--mn);font-size:10px;letter-spacing:.2em;text-transform:uppercase;color:var(--g7);margin-bottom:20px;opacity:0;animation:up .8s var(--sm) .2s forwards}
.h-title{font-family:var(--mn);font-size:clamp(22px,4.5vw,44px);font-weight:400;line-height:1.15;text-transform:uppercase;margin-bottom:16px;opacity:0;animation:up .8s var(--sm) .35s forwards}
.h-title span{color:var(--or)}
.h-sub{font-size:clamp(14px,2.5vw,16px);font-weight:300;color:var(--g7);max-width:680px;line-height:1.75;margin-bottom:12px;opacity:0;animation:up .8s var(--sm) .5s forwards}

/* ENGINE APP */
#engine-root{opacity:0;animation:up .8s var(--sm) .65s forwards}

/* TABS */
.e-tabs{display:flex;gap:0;border-bottom:1px solid var(--g3);margin-bottom:24px}
.e-tab{font-family:var(--mn);font-size:10px;letter-spacing:.08em;text-transform:uppercase;padding:10px 18px;border:none;background:transparent;color:var(--g6);cursor:pointer;border-bottom:2px solid transparent;transition:all .3s var(--ez)}
.e-tab:hover{color:var(--bk)}
.e-tab.on{color:var(--or);border-bottom-color:var(--or)}

/* INPUT PANELS */
.e-panel{display:none}.e-panel.vis{display:block}
.e-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
@media(max-width:700px){.e-grid{grid-template-columns:1fr}}
.e-card{padding:20px;background:var(--wh);border:1px solid var(--g3);transition:border-color .3s var(--ez)}
.e-card:hover{border-color:var(--g5)}
.e-card-title{font-family:var(--mn);font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--or);margin-bottom:14px}

/* FORM FIELDS */
.e-field{margin-bottom:12px}
.e-field label{display:block;font-family:var(--mn);font-size:8px;letter-spacing:.08em;text-transform:uppercase;color:var(--g6);margin-bottom:4px}
.e-field input,.e-field select{width:100%;font-family:var(--mn);font-size:12px;padding:8px 10px;border:1px solid var(--g3);background:var(--g50);color:var(--bk);transition:border-color .3s var(--ez);outline:none}
.e-field input:focus,.e-field select:focus{border-color:var(--or)}
.e-field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* BUTTONS */
.e-btn{font-family:var(--mn);font-size:10px;padding:10px 24px;border:1px solid var(--bk);background:var(--bk);color:var(--wh);cursor:pointer;transition:all .4s var(--ez);text-transform:lowercase;letter-spacing:.02em;width:100%}
.e-btn:hover{background:var(--or);border-color:var(--or);color:var(--bk)}
.e-btn-row{display:flex;gap:10px;margin-bottom:28px}
.e-btn-secondary{font-family:var(--mn);font-size:10px;padding:10px 24px;border:1px solid var(--g3);background:transparent;color:var(--g7);cursor:pointer;transition:all .4s var(--ez);text-transform:lowercase;letter-spacing:.02em}
.e-btn-secondary:hover{border-color:var(--bk);color:var(--bk)}

/* RESULTS */
.e-results{margin-top:28px}
.e-result-header{font-family:var(--mn);font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--g7);margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--g3)}
.e-metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:28px}
.e-metric{padding:16px;background:var(--wh);border:1px solid var(--g3)}
.e-metric-label{font-family:var(--mn);font-size:8px;letter-spacing:.08em;text-transform:uppercase;color:var(--g6);margin-bottom:6px}
.e-metric-val{font-family:var(--mn);font-size:clamp(16px,3vw,22px);font-weight:700;color:var(--or)}
.e-metric-note{font-size:11px;font-weight:300;color:var(--g6);margin-top:4px}
.e-metric-delta{font-family:var(--mn);font-size:10px;margin-top:4px}
.e-metric-delta.up{color:#c0392b}
.e-metric-delta.down{color:#27ae60}

/* CHARTS */
.e-chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
@media(max-width:800px){.e-chart-grid{grid-template-columns:1fr}}
.e-chart-wrap{background:var(--wh);border:1px solid var(--g3);padding:16px}
.e-chart-title{font-family:var(--mn);font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--g7);margin-bottom:12px}
.e-chart-canvas{width:100%;height:240px}

/* SCENARIO TABLE */
.e-table-wrap{overflow-x:auto;margin-bottom:28px}
.e-table{width:100%;border-collapse:collapse;font-size:12px}
.e-table th{font-family:var(--mn);font-size:8px;letter-spacing:.08em;text-transform:uppercase;color:var(--g6);padding:8px 12px;text-align:left;border-bottom:2px solid var(--g3);background:var(--g50)}
.e-table td{padding:8px 12px;border-bottom:1px solid var(--g3);color:var(--g7);font-weight:300}
.e-table tr:hover td{background:var(--g50)}
.e-table td.val{font-family:var(--mn);font-weight:400;color:var(--bk)}
.e-table td.warn{color:#c0392b}
.e-table td.good{color:#27ae60}
.e-table td.accent{color:var(--or);font-weight:500}

/* SEGMENT BADGES */
.e-seg{font-family:var(--mn);font-size:8px;letter-spacing:.06em;text-transform:uppercase;padding:3px 8px;border:1px solid var(--g3);display:inline-block;margin-right:4px;margin-bottom:4px}
.e-seg.active{border-color:var(--or);color:var(--or)}

/* DARK SECTION */
.e-dark{background:var(--bk);color:var(--wh);padding:28px;margin:28px 0}
.e-dark .e-metric{background:var(--g9);border-color:rgba(255,255,255,.07)}
.e-dark .e-metric-label{color:var(--g5)}
.e-dark .e-metric-val{color:var(--or)}
.e-dark .e-chart-wrap{background:var(--g9);border-color:rgba(255,255,255,.07)}
.e-dark .e-chart-title{color:var(--g5)}
.e-dark .e-result-header{color:var(--g5);border-color:rgba(255,255,255,.1)}

/* FOOTER */
.foot{padding:32px 20px;border-top:1px solid var(--g3);text-align:center;margin-top:40px}
.foot-text{font-family:var(--mn);font-size:9px;color:var(--g5);letter-spacing:.06em}

/* EMPTY STATE */
.e-empty{padding:60px 20px;text-align:center;border:1px dashed var(--g3)}
.e-empty-title{font-family:var(--mn);font-size:12px;color:var(--g6);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.e-empty-sub{font-size:13px;font-weight:300;color:var(--g5)}
</style>
</head>
<body>
<nav class="nav" id="nav">
  <div class="n-logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
    <span class="n-word">governed revenue</span>
  </div>
  <div class="nr">
    <a class="n-lnk" href="../index.html">home</a>
    <a class="n-lnk" href="../spine-v4.html">spine</a>
    <a class="n-lnk" href="../sovereignty-map.html">sovereignty</a>
    <a class="n-lnk" href="../split-funnel-map.html">motion</a>
    <a class="n-lnk active" href="revenue-physics-engine.html">physics engine</a>
    <button class="ham" onclick="document.getElementById('mobMenu').classList.toggle('open')" aria-label="Menu"><span></span><span></span><span></span></button>
  </div>
</nav>
<div class="mob-menu" id="mobMenu">
  <div class="mob-btns">
    <a class="btn-out" href="../index.html" style="flex:1;text-align:center">home</a>
    <a class="btn-fill" href="../index.html#briefing" style="flex:1;text-align:center">strategic briefing</a>
  </div>
  <a class="mob-lnk" href="../spine-v4.html">spine</a>
  <a class="mob-lnk" href="../sovereignty-map.html">sovereignty map</a>
  <a class="mob-lnk" href="../split-funnel-map.html">motion map</a>
  <a class="mob-lnk" href="../lexicon.html">lexicon</a>
  <a class="mob-lnk" href="../identity-graph.html">identity graph</a>
  <a class="mob-lnk" href="../provenance.html">provenance</a>
  <a class="mob-lnk" href="../agent-specs.html">agent specs</a>
  <a class="mob-lnk" href="../infrastructure.html">infrastructure</a>
  <a class="mob-lnk" href="revenue-physics-engine.html" style="color:var(--or)">physics engine</a>
</div>

<section class="hero w">
  <div class="h-ey">tools &mdash; revenue physics engine</div>
  <h1 class="h-title">Revenue <span>Physics Engine</span></h1>
  <p class="h-sub">Model revenue dynamics under constraint. Multi-segment scenario analysis with drift decay, pipeline stress testing, and capital allocation visualization. The economics don&rsquo;t lie&mdash;the engine makes them visible.</p>
</section>

<div class="w">
  <div id="engine-root"></div>
</div>

<footer class="foot"><div class="foot-text">governed revenue architecture &middot; revenue physics engine &middot; 2026</div></footer>

<script>
// Nav scroll behavior
const nav=document.getElementById('nav');
window.addEventListener('scroll',()=>{nav.classList.toggle('scrolled',window.scrollY>40)},{passive:true});
</script>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ── Utility Functions ──
function fmt(n) {
  if (Math.abs(n) >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
  if (Math.abs(n) >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'K';
  return '$' + n.toFixed(0);
}

function pct(n) { return (n * 100).toFixed(1) + '%'; }
function num(n) { return n.toLocaleString(); }

function parseNum(val) {
  return parseFloat(String(val).replace(/,/g, '')) || 0;
}

// ── Computation Engine ──
function computeSegment(inputs) {
  const { arr, acv, winRate, cycleDays, cac, coverageMultiple } = inputs;
  const wr = winRate / 100;
  if (!arr || !acv || !wr || !cac || !coverageMultiple) return null;

  const logos = Math.ceil(arr / acv);
  const pipeline = arr * coverageMultiple;
  const opps = Math.ceil(logos / wr);
  const budget = logos * cac;
  const ltv3 = (acv * 3 * 0.75) / cac;
  const qVelocity = Math.ceil(opps / (365 / cycleDays) / 4);
  const magicNumber = (arr / budget);
  const paybackMonths = (cac / (acv / 12));
  const cacRatio = cac / acv;

  return {
    logos, pipeline, opps, budget, ltv3, qVelocity,
    magicNumber, paybackMonths, cacRatio,
    arr, acv, winRate: wr, cycleDays, cac, coverageMultiple
  };
}

function computeDrift(baseline, drift) {
  if (!baseline) return null;
  const { winRate, cycleDays, cac, coverageMultiple, arr, acv, logos } = baseline;
  const wrDecay = drift.winRateDecay / 100;
  const cycleAdd = drift.cycleElongation;
  const cacCreep = drift.cacCreep / 100;
  const pipeInflation = drift.pipelineInflation / 100;

  const wr2 = Math.max(winRate * (1 - wrDecay), 0.0001);
  const cyc2 = Math.max(cycleDays + cycleAdd, 1);
  const cac2 = cac * (1 + cacCreep);
  const pipe2 = arr * coverageMultiple * (1 + pipeInflation);
  const opps2 = Math.ceil(logos / wr2);
  const budget2 = logos * cac2;
  const qVelocity2 = Math.ceil(opps2 / (365 / cyc2) / 4);
  const ltv2 = (acv * 3 * 0.75) / cac2;

  const pipeDelta = pipe2 - baseline.pipeline;
  const budgetDelta = budget2 - baseline.budget;
  const oppDelta = opps2 - baseline.opps;

  const volatility = ((pipe2 / baseline.pipeline - 1) + (budget2 / baseline.budget - 1) + (opps2 / baseline.opps - 1)) / 3;

  return {
    pipeline: pipe2, opps: opps2, budget: budget2,
    qVelocity: qVelocity2, ltv3: ltv2,
    pipeDelta, budgetDelta, oppDelta,
    volatility: Math.max(0, Math.min(volatility, 9.99)),
    winRate: wr2, cycleDays: cyc2, cac: cac2
  };
}

// ── Quarter-over-quarter projection ──
function projectQuarters(baseline, drift, quarters) {
  if (!baseline) return [];
  const results = [];
  let currentWr = baseline.winRate;
  let currentCyc = baseline.cycleDays;
  let currentCac = baseline.cac;
  const wrDecayPerQ = (drift.winRateDecay / 100) / 4;
  const cycAddPerQ = drift.cycleElongation / 4;
  const cacCreepPerQ = (drift.cacCreep / 100) / 4;

  for (let q = 0; q < quarters; q++) {
    if (q > 0) {
      currentWr = Math.max(currentWr * (1 - wrDecayPerQ), 0.01);
      currentCyc = currentCyc + cycAddPerQ;
      currentCac = currentCac * (1 + cacCreepPerQ);
    }
    const opps = Math.ceil(baseline.logos / currentWr);
    const budget = baseline.logos * currentCac;
    const pipe = baseline.arr * baseline.coverageMultiple * (1 + (drift.pipelineInflation / 100) * (q / quarters));
    const vel = Math.ceil(opps / (365 / currentCyc) / 4);
    const ltv = (baseline.acv * 3 * 0.75) / currentCac;

    results.push({
      quarter: `Q${q + 1}`,
      winRate: currentWr, cycleDays: currentCyc, cac: currentCac,
      opps, budget, pipeline: pipe, velocity: vel, ltv
    });
  }
  return results;
}

// ── Chart Component ──
function EngineChart({ id, title, type, data, options, darkMode }) {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);

  useEffect(() => {
    if (!canvasRef.current || !data) return;
    if (chartRef.current) chartRef.current.destroy();

    const ctx = canvasRef.current.getContext('2d');
    const textColor = darkMode ? '#a3a3a3' : '#747474';
    const gridColor = darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';

    chartRef.current = new Chart(ctx, {
      type,
      data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: textColor, font: { family: "'Space Mono', monospace", size: 9 } }
          },
          tooltip: {
            titleFont: { family: "'Space Mono', monospace", size: 10 },
            bodyFont: { family: "'Oxanium', sans-serif", size: 11 }
          }
        },
        scales: type !== 'doughnut' && type !== 'pie' ? {
          x: { ticks: { color: textColor, font: { family: "'Space Mono', monospace", size: 9 } }, grid: { color: gridColor } },
          y: { ticks: { color: textColor, font: { family: "'Space Mono', monospace", size: 9 } }, grid: { color: gridColor } }
        } : undefined,
        ...options
      }
    });

    return () => { if (chartRef.current) chartRef.current.destroy(); };
  }, [data, type, options, darkMode]);

  return (
    <div className={`e-chart-wrap${darkMode ? ' e-dark' : ''}`}>
      <div className="e-chart-title">{title}</div>
      <div className="e-chart-canvas">
        <canvas ref={canvasRef} style={{ width: '100%', height: '100%' }}></canvas>
      </div>
    </div>
  );
}

// ── Input Field Component ──
function Field({ label, id, value, onChange, placeholder, suffix }) {
  return (
    <div className="e-field">
      <label htmlFor={id}>{label}{suffix && ` (${suffix})`}</label>
      <input
        type="text" id={id} value={value} placeholder={placeholder}
        onChange={e => onChange(e.target.value)}
      />
    </div>
  );
}

// ── Metric Card Component ──
function Metric({ label, value, note, delta, deltaDir }) {
  return (
    <div className="e-metric">
      <div className="e-metric-label">{label}</div>
      <div className="e-metric-val">{value}</div>
      {note && <div className="e-metric-note">{note}</div>}
      {delta && <div className={`e-metric-delta ${deltaDir}`}>{delta}</div>}
    </div>
  );
}

// ── Segment Config ──
const DEFAULT_SEGMENTS = [
  { name: 'Enterprise', arr: '5,000,000', acv: '120,000', winRate: '18', cycleDays: '120', cac: '35,000', coverageMultiple: '4' },
  { name: 'Mid-Market', arr: '3,000,000', acv: '48,000', winRate: '22', cycleDays: '75', cac: '18,000', coverageMultiple: '3.5' },
  { name: 'SMB', arr: '2,000,000', acv: '12,000', winRate: '30', cycleDays: '30', cac: '5,000', coverageMultiple: '3' }
];

const DEFAULT_DRIFT = { winRateDecay: '15', cycleElongation: '20', cacCreep: '12', pipelineInflation: '25' };

// ── Main App ──
function RevenuePhysicsEngine() {
  const [tab, setTab] = useState('model');
  const [segments, setSegments] = useState(DEFAULT_SEGMENTS);
  const [drift, setDrift] = useState(DEFAULT_DRIFT);
  const [results, setResults] = useState(null);
  const [projectionQuarters, setProjectionQuarters] = useState('8');

  const updateSegment = (idx, field, value) => {
    const updated = [...segments];
    updated[idx] = { ...updated[idx], [field]: value };
    setSegments(updated);
  };

  const addSegment = () => {
    setSegments([...segments, { name: 'New Segment', arr: '1,000,000', acv: '30,000', winRate: '25', cycleDays: '60', cac: '12,000', coverageMultiple: '3.5' }]);
  };

  const removeSegment = (idx) => {
    if (segments.length <= 1) return;
    setSegments(segments.filter((_, i) => i !== idx));
  };

  const runEngine = useCallback(() => {
    const driftParams = {
      winRateDecay: parseNum(drift.winRateDecay),
      cycleElongation: parseNum(drift.cycleElongation),
      cacCreep: parseNum(drift.cacCreep),
      pipelineInflation: parseNum(drift.pipelineInflation)
    };

    const segResults = segments.map(seg => {
      const inputs = {
        arr: parseNum(seg.arr), acv: parseNum(seg.acv),
        winRate: parseNum(seg.winRate), cycleDays: parseNum(seg.cycleDays),
        cac: parseNum(seg.cac), coverageMultiple: parseNum(seg.coverageMultiple)
      };
      const baseline = computeSegment(inputs);
      const drifted = baseline ? computeDrift(baseline, driftParams) : null;
      const projection = baseline ? projectQuarters(baseline, driftParams, parseInt(projectionQuarters) || 8) : [];
      return { name: seg.name, baseline, drifted, projection };
    }).filter(r => r.baseline !== null);

    if (segResults.length === 0) return;

    // Aggregate totals
    const totals = {
      arr: segResults.reduce((s, r) => s + r.baseline.arr, 0),
      logos: segResults.reduce((s, r) => s + r.baseline.logos, 0),
      pipeline: segResults.reduce((s, r) => s + r.baseline.pipeline, 0),
      opps: segResults.reduce((s, r) => s + r.baseline.opps, 0),
      budget: segResults.reduce((s, r) => s + r.baseline.budget, 0),
      driftBudget: segResults.reduce((s, r) => s + (r.drifted ? r.drifted.budget : r.baseline.budget), 0),
      driftPipeline: segResults.reduce((s, r) => s + (r.drifted ? r.drifted.pipeline : r.baseline.pipeline), 0),
      driftOpps: segResults.reduce((s, r) => s + (r.drifted ? r.drifted.opps : r.baseline.opps), 0)
    };

    const weightedLtv = segResults.reduce((s, r) => s + r.baseline.ltv3 * r.baseline.arr, 0) / totals.arr;
    totals.ltv3 = weightedLtv;
    totals.magicNumber = totals.arr / totals.budget;

    setResults({ segments: segResults, totals, driftParams });
    setTab('results');
  }, [segments, drift, projectionQuarters]);

  const resetEngine = () => {
    setSegments(DEFAULT_SEGMENTS);
    setDrift(DEFAULT_DRIFT);
    setResults(null);
    setTab('model');
  };

  // ── Chart Data Builders ──
  const buildPipelineChart = () => {
    if (!results) return null;
    return {
      labels: results.segments.map(s => s.name),
      datasets: [
        {
          label: 'Baseline Pipeline',
          data: results.segments.map(s => s.baseline.pipeline),
          backgroundColor: 'rgba(255, 110, 62, 0.7)',
          borderColor: '#ff6e3e',
          borderWidth: 1
        },
        {
          label: 'Drift Pipeline',
          data: results.segments.map(s => s.drifted ? s.drifted.pipeline : s.baseline.pipeline),
          backgroundColor: 'rgba(188, 190, 255, 0.7)',
          borderColor: '#bcbeff',
          borderWidth: 1
        }
      ]
    };
  };

  const buildBudgetChart = () => {
    if (!results) return null;
    return {
      labels: results.segments.map(s => s.name),
      datasets: [{
        data: results.segments.map(s => s.baseline.budget),
        backgroundColor: ['#ff6e3e', '#bcbeff', '#1a1918', '#747474', '#d9d9d9'],
        borderWidth: 0
      }]
    };
  };

  const buildProjectionChart = () => {
    if (!results || results.segments.length === 0) return null;
    const seg = results.segments[0];
    if (!seg.projection || seg.projection.length === 0) return null;
    return {
      labels: seg.projection.map(p => p.quarter),
      datasets: [
        {
          label: 'Win Rate',
          data: seg.projection.map(p => (p.winRate * 100).toFixed(1)),
          borderColor: '#ff6e3e',
          backgroundColor: 'rgba(255, 110, 62, 0.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'CAC ($K)',
          data: seg.projection.map(p => (p.cac / 1000).toFixed(1)),
          borderColor: '#bcbeff',
          backgroundColor: 'rgba(188, 190, 255, 0.1)',
          fill: true,
          tension: 0.3,
          yAxisID: 'y1'
        }
      ]
    };
  };

  const buildVelocityChart = () => {
    if (!results) return null;
    return {
      labels: results.segments.map(s => s.name),
      datasets: [
        {
          label: 'Baseline Velocity',
          data: results.segments.map(s => s.baseline.qVelocity),
          backgroundColor: 'rgba(255, 110, 62, 0.7)',
          borderColor: '#ff6e3e',
          borderWidth: 1
        },
        {
          label: 'Drift Velocity',
          data: results.segments.map(s => s.drifted ? s.drifted.qVelocity : s.baseline.qVelocity),
          backgroundColor: 'rgba(188, 190, 255, 0.7)',
          borderColor: '#bcbeff',
          borderWidth: 1
        }
      ]
    };
  };

  return (
    <div>
      {/* Tabs */}
      <div className="e-tabs">
        <button className={`e-tab${tab === 'model' ? ' on' : ''}`} onClick={() => setTab('model')}>model inputs</button>
        <button className={`e-tab${tab === 'drift' ? ' on' : ''}`} onClick={() => setTab('drift')}>drift parameters</button>
        <button className={`e-tab${tab === 'results' ? ' on' : ''}`} onClick={() => setTab('results')}>results</button>
        <button className={`e-tab${tab === 'projection' ? ' on' : ''}`} onClick={() => setTab('projection')}>projection</button>
      </div>

      {/* ── Model Inputs Tab ── */}
      <div className={`e-panel${tab === 'model' ? ' vis' : ''}`}>
        <div className="e-grid">
          {segments.map((seg, idx) => (
            <div className="e-card" key={idx}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 14 }}>
                <div className="e-card-title">segment {idx + 1}</div>
                {segments.length > 1 && (
                  <button onClick={() => removeSegment(idx)}
                    style={{ background: 'none', border: '1px solid var(--g3)', fontFamily: 'var(--mn)', fontSize: '8px', padding: '2px 8px', color: 'var(--g6)', cursor: 'pointer', textTransform: 'uppercase', letterSpacing: '.06em' }}>
                    remove
                  </button>
                )}
              </div>
              <Field label="Segment Name" id={`seg-name-${idx}`} value={seg.name}
                onChange={v => updateSegment(idx, 'name', v)} placeholder="Enterprise" />
              <Field label="ARR Target" id={`seg-arr-${idx}`} value={seg.arr}
                onChange={v => updateSegment(idx, 'arr', v)} placeholder="5,000,000" suffix="$" />
              <div className="e-field-row">
                <Field label="Average ACV" id={`seg-acv-${idx}`} value={seg.acv}
                  onChange={v => updateSegment(idx, 'acv', v)} placeholder="120,000" suffix="$" />
                <Field label="Win Rate" id={`seg-wr-${idx}`} value={seg.winRate}
                  onChange={v => updateSegment(idx, 'winRate', v)} placeholder="18" suffix="%" />
              </div>
              <div className="e-field-row">
                <Field label="Avg Sales Cycle" id={`seg-cyc-${idx}`} value={seg.cycleDays}
                  onChange={v => updateSegment(idx, 'cycleDays', v)} placeholder="120" suffix="days" />
                <Field label="Blended CAC" id={`seg-cac-${idx}`} value={seg.cac}
                  onChange={v => updateSegment(idx, 'cac', v)} placeholder="35,000" suffix="$" />
              </div>
              <Field label="Coverage Multiple" id={`seg-cov-${idx}`} value={seg.coverageMultiple}
                onChange={v => updateSegment(idx, 'coverageMultiple', v)} placeholder="4" suffix="x" />
            </div>
          ))}
        </div>

        <div className="e-btn-row">
          <button className="e-btn" onClick={runEngine}>run physics engine</button>
          <button className="e-btn-secondary" onClick={addSegment}>+ add segment</button>
          <button className="e-btn-secondary" onClick={resetEngine}>reset</button>
        </div>
      </div>

      {/* ── Drift Parameters Tab ── */}
      <div className={`e-panel${tab === 'drift' ? ' vis' : ''}`}>
        <div className="e-grid">
          <div className="e-card">
            <div className="e-card-title">drift decay parameters</div>
            <p style={{ fontSize: '13px', fontWeight: 300, color: 'var(--g7)', lineHeight: 1.75, marginBottom: 16 }}>
              Model the compounding degradation that occurs when revenue operations lack governance.
              These parameters apply uniformly across all segments.
            </p>
            <Field label="Win-Rate Decay" id="d-wrdec" value={drift.winRateDecay}
              onChange={v => setDrift({ ...drift, winRateDecay: v })} placeholder="15" suffix="%" />
            <Field label="Cycle Elongation" id="d-cycadd" value={drift.cycleElongation}
              onChange={v => setDrift({ ...drift, cycleElongation: v })} placeholder="20" suffix="days" />
            <Field label="CAC Creep" id="d-cacinc" value={drift.cacCreep}
              onChange={v => setDrift({ ...drift, cacCreep: v })} placeholder="12" suffix="%" />
            <Field label="Pipeline Inflation" id="d-infl" value={drift.pipelineInflation}
              onChange={v => setDrift({ ...drift, pipelineInflation: v })} placeholder="25" suffix="%" />
          </div>
          <div className="e-card">
            <div className="e-card-title">projection horizon</div>
            <p style={{ fontSize: '13px', fontWeight: 300, color: 'var(--g7)', lineHeight: 1.75, marginBottom: 16 }}>
              Set the number of quarters to project forward. Drift compounds quarter-over-quarter&mdash;longer
              horizons reveal the true cost of ungoverned operations.
            </p>
            <Field label="Quarters to Project" id="d-quarters" value={projectionQuarters}
              onChange={v => setProjectionQuarters(v)} placeholder="8" suffix="Q" />
            <div style={{ marginTop: 20 }}>
              <button className="e-btn" onClick={runEngine}>run physics engine</button>
            </div>
          </div>
        </div>
      </div>

      {/* ── Results Tab ── */}
      <div className={`e-panel${tab === 'results' ? ' vis' : ''}`}>
        {!results ? (
          <div className="e-empty">
            <div className="e-empty-title">no simulation data</div>
            <div className="e-empty-sub">Configure your segments and run the physics engine to see results.</div>
          </div>
        ) : (
          <>
            {/* Aggregate Metrics */}
            <div className="e-result-header">aggregate baseline</div>
            <div className="e-metrics">
              <Metric label="Total ARR Target" value={fmt(results.totals.arr)} />
              <Metric label="Total New Logos" value={num(results.totals.logos)} note="across all segments" />
              <Metric label="Required Pipeline" value={fmt(results.totals.pipeline)}
                delta={results.totals.driftPipeline !== results.totals.pipeline ?
                  `drift: ${fmt(results.totals.driftPipeline)} (+${fmt(results.totals.driftPipeline - results.totals.pipeline)})` : null}
                deltaDir="up" />
              <Metric label="Total Opportunities" value={num(results.totals.opps)}
                delta={results.totals.driftOpps !== results.totals.opps ?
                  `drift: ${num(results.totals.driftOpps)} (+${num(results.totals.driftOpps - results.totals.opps)})` : null}
                deltaDir="up" />
              <Metric label="Acquisition Budget" value={fmt(results.totals.budget)}
                delta={results.totals.driftBudget !== results.totals.budget ?
                  `drift: ${fmt(results.totals.driftBudget)} (+${fmt(results.totals.driftBudget - results.totals.budget)})` : null}
                deltaDir="up" />
              <Metric label="Wtd LTV:CAC" value={results.totals.ltv3.toFixed(1) + 'x'}
                note="3yr LTV at 75% margin" />
              <Metric label="Magic Number" value={results.totals.magicNumber.toFixed(2)}
                note="ARR / total acquisition spend" />
            </div>

            {/* Charts */}
            <div className="e-chart-grid">
              <EngineChart id="pipeline-chart" title="pipeline: baseline vs drift"
                type="bar" data={buildPipelineChart()} />
              <EngineChart id="budget-chart" title="budget allocation by segment"
                type="doughnut" data={buildBudgetChart()}
                options={{ cutout: '55%' }} />
              <EngineChart id="velocity-chart" title="quarterly velocity: baseline vs drift"
                type="bar" data={buildVelocityChart()} />
            </div>

            {/* Segment Comparison Table */}
            <div className="e-result-header">segment comparison</div>
            <div className="e-table-wrap">
              <table className="e-table">
                <thead>
                  <tr>
                    <th>Segment</th>
                    <th>ARR</th>
                    <th>Logos</th>
                    <th>Pipeline</th>
                    <th>Opps</th>
                    <th>Budget</th>
                    <th>LTV:CAC</th>
                    <th>Velocity</th>
                    <th>Volatility</th>
                  </tr>
                </thead>
                <tbody>
                  {results.segments.map((seg, idx) => (
                    <tr key={idx}>
                      <td className="val">{seg.name}</td>
                      <td className="val">{fmt(seg.baseline.arr)}</td>
                      <td>{num(seg.baseline.logos)}</td>
                      <td>{fmt(seg.baseline.pipeline)}</td>
                      <td>{num(seg.baseline.opps)}</td>
                      <td>{fmt(seg.baseline.budget)}</td>
                      <td className={seg.baseline.ltv3 >= 3 ? 'good' : seg.baseline.ltv3 < 1.5 ? 'warn' : ''}>
                        {seg.baseline.ltv3.toFixed(1)}x
                      </td>
                      <td>{num(seg.baseline.qVelocity)}/Q</td>
                      <td className={seg.drifted && seg.drifted.volatility > 0.15 ? 'warn' : ''}>
                        {seg.drifted ? (seg.drifted.volatility * 100).toFixed(0) + '%' : '—'}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Drift Detail */}
            <div className="e-dark">
              <div className="e-result-header">drift impact analysis</div>
              <div className="e-metrics">
                {results.segments.map((seg, idx) => (
                  seg.drifted && (
                    <Metric key={idx}
                      label={`${seg.name} drift`}
                      value={(seg.drifted.volatility * 100).toFixed(0) + '% volatility'}
                      note={`Pipeline: +${fmt(seg.drifted.pipeDelta)} | Budget: +${fmt(seg.drifted.budgetDelta)} | Opps: +${num(seg.drifted.oppDelta)}`}
                    />
                  )
                ))}
                <Metric label="Total Drift Cost"
                  value={fmt(results.totals.driftBudget - results.totals.budget)}
                  note="additional budget required to hold targets under drift" />
              </div>
            </div>
          </>
        )}
      </div>

      {/* ── Projection Tab ── */}
      <div className={`e-panel${tab === 'projection' ? ' vis' : ''}`}>
        {!results ? (
          <div className="e-empty">
            <div className="e-empty-title">no simulation data</div>
            <div className="e-empty-sub">Configure your segments and run the physics engine to see projections.</div>
          </div>
        ) : (
          <>
            {results.segments.map((seg, sIdx) => (
              <div key={sIdx} style={{ marginBottom: 40 }}>
                <div className="e-result-header">{seg.name} &mdash; {projectionQuarters}-quarter projection</div>

                {/* Projection chart for this segment */}
                <div className="e-chart-grid">
                  <EngineChart
                    id={`proj-chart-${sIdx}`}
                    title={`${seg.name}: win rate & cac decay`}
                    type="line"
                    data={{
                      labels: seg.projection.map(p => p.quarter),
                      datasets: [
                        {
                          label: 'Win Rate (%)',
                          data: seg.projection.map(p => (p.winRate * 100).toFixed(1)),
                          borderColor: '#ff6e3e',
                          backgroundColor: 'rgba(255, 110, 62, 0.1)',
                          fill: true,
                          tension: 0.3
                        },
                        {
                          label: 'CAC ($K)',
                          data: seg.projection.map(p => (p.cac / 1000).toFixed(1)),
                          borderColor: '#bcbeff',
                          backgroundColor: 'rgba(188, 190, 255, 0.1)',
                          fill: true,
                          tension: 0.3,
                          yAxisID: 'y1'
                        }
                      ]
                    }}
                    options={{
                      scales: {
                        y: { position: 'left', title: { display: true, text: 'Win Rate %', color: '#747474', font: { family: "'Space Mono', monospace", size: 9 } } },
                        y1: { position: 'right', title: { display: true, text: 'CAC ($K)', color: '#747474', font: { family: "'Space Mono', monospace", size: 9 } }, grid: { drawOnChartArea: false } }
                      }
                    }}
                  />
                  <EngineChart
                    id={`proj-budget-${sIdx}`}
                    title={`${seg.name}: budget & pipeline growth`}
                    type="line"
                    data={{
                      labels: seg.projection.map(p => p.quarter),
                      datasets: [
                        {
                          label: 'Budget ($K)',
                          data: seg.projection.map(p => (p.budget / 1000).toFixed(0)),
                          borderColor: '#ff6e3e',
                          backgroundColor: 'rgba(255, 110, 62, 0.1)',
                          fill: true,
                          tension: 0.3
                        },
                        {
                          label: 'Pipeline ($K)',
                          data: seg.projection.map(p => (p.pipeline / 1000).toFixed(0)),
                          borderColor: '#1a1918',
                          backgroundColor: 'rgba(26, 25, 24, 0.05)',
                          fill: true,
                          tension: 0.3,
                          yAxisID: 'y1'
                        }
                      ]
                    }}
                    options={{
                      scales: {
                        y: { position: 'left', title: { display: true, text: 'Budget ($K)', color: '#747474', font: { family: "'Space Mono', monospace", size: 9 } } },
                        y1: { position: 'right', title: { display: true, text: 'Pipeline ($K)', color: '#747474', font: { family: "'Space Mono', monospace", size: 9 } }, grid: { drawOnChartArea: false } }
                      }
                    }}
                  />
                </div>

                {/* Projection Table */}
                <div className="e-table-wrap">
                  <table className="e-table">
                    <thead>
                      <tr>
                        <th>Quarter</th>
                        <th>Win Rate</th>
                        <th>Cycle</th>
                        <th>CAC</th>
                        <th>Opps</th>
                        <th>Budget</th>
                        <th>Pipeline</th>
                        <th>LTV:CAC</th>
                      </tr>
                    </thead>
                    <tbody>
                      {seg.projection.map((p, qIdx) => (
                        <tr key={qIdx}>
                          <td className="val">{p.quarter}</td>
                          <td className={p.winRate < seg.baseline.winRate * 0.7 ? 'warn' : ''}>
                            {(p.winRate * 100).toFixed(1)}%
                          </td>
                          <td>{Math.round(p.cycleDays)}d</td>
                          <td className={p.cac > seg.baseline.cac * 1.3 ? 'warn' : ''}>{fmt(p.cac)}</td>
                          <td>{num(p.opps)}</td>
                          <td>{fmt(p.budget)}</td>
                          <td>{fmt(p.pipeline)}</td>
                          <td className={p.ltv < 1.5 ? 'warn' : p.ltv >= 3 ? 'good' : ''}>
                            {p.ltv.toFixed(1)}x
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ))}
          </>
        )}
      </div>
    </div>
  );
}

// ── Mount ──
const root = ReactDOM.createRoot(document.getElementById('engine-root'));
root.render(<RevenuePhysicsEngine />);
</script>
</body>
</html>
